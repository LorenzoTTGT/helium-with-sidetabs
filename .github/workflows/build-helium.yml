name: Vertical Tabs Patches - Ready to Use

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main, master ]
    paths:
      - 'helium/patches/**'
      - '.github/workflows/**'

jobs:
  validate-patches:
    name: Validate Patch Files
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate patch syntax
      run: |
        echo "ðŸ” Validating vertical tabs patch files..."

        patches=(
          "helium/patches/helium/ui/vertical-tabs.patch"
          "helium/patches/helium/ui/vertical-tabs-resizable.patch"
          "helium/patches/helium/ui/vertical-tabs-context-menu.patch"
          "helium/patches/helium/ui/hide-horizontal-tabs.patch"
          "helium/patches/helium/ui/vertical-tab-style.patch"
        )

        all_valid=true
        for patch in "${patches[@]}"; do
          if [ -f "$patch" ]; then
            echo "âœ… Found: $patch"
            # Check if it's a valid unified diff
            if head -1 "$patch" | grep -q "^---"; then
              echo "   Valid unified diff format"
            else
              echo "   âš ï¸  Warning: May not be valid unified diff format"
              all_valid=false
            fi
          else
            echo "âŒ Missing: $patch"
            all_valid=false
          fi
        done

        if [ "$all_valid" = true ]; then
          echo ""
          echo "âœ… All patch files are present and valid!"
        else
          echo ""
          echo "âš ï¸  Some patch files have issues"
          exit 1
        fi

    - name: Create patch summary
      run: |
        echo "## ðŸ“¦ Vertical Tabs Patches for Helium" > patch_summary.md
        echo "" >> patch_summary.md
        echo "This repository contains **5 patch files** to add vertical tabs to Helium browser:" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "### Patch Files:" >> patch_summary.md
        echo "1. **vertical-tabs.patch** - Core vertical tabs implementation" >> patch_summary.md
        echo "2. **vertical-tabs-resizable.patch** - Drag-to-resize sidebar (150-500px)" >> patch_summary.md
        echo "3. **vertical-tabs-context-menu.patch** - Right-click menu for settings" >> patch_summary.md
        echo "4. **hide-horizontal-tabs.patch** - Hides the top tab bar" >> patch_summary.md
        echo "5. **vertical-tab-style.patch** - Visual styling (240Ã—36px tabs)" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "### Features:" >> patch_summary.md
        echo "- âœ… Resizable sidebar (drag edge to resize)" >> patch_summary.md
        echo "- âœ… Left or right positioning" >> patch_summary.md
        echo "- âœ… Right-click context menu" >> patch_summary.md
        echo "- âœ… Persistent preferences" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "### To Build Helium with These Patches:" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "Since Helium uses platform-specific build repos, you'll need to:" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "1. Fork the platform repo you want:" >> patch_summary.md
        echo "   - macOS: https://github.com/imputnet/helium-macos" >> patch_summary.md
        echo "   - Linux: https://github.com/imputnet/helium-linux" >> patch_summary.md
        echo "   - Windows: https://github.com/imputnet/helium-windows" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "2. Copy these 5 patch files to the forked repo's \`patches/helium/ui/\` directory" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "3. Trigger their existing build workflow" >> patch_summary.md
        echo "" >> patch_summary.md
        echo "**OR** use the provided build script for local builds (see BUILD_INSTRUCTIONS.md)" >> patch_summary.md

        cat patch_summary.md

    - name: Upload patch summary
      uses: actions/upload-artifact@v4
      with:
        name: patch-summary
        path: patch_summary.md
        retention-days: 90

  test-patch-application:
    name: Test Patch Application
    runs-on: ubuntu-latest
    needs: validate-patches

    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4
      with:
        path: patches-repo

    - name: Clone Helium main repo
      run: |
        git clone --depth=1 https://github.com/imputnet/helium.git helium-test

    - name: Copy patches to Helium repo
      run: |
        echo "ðŸ“‹ Copying vertical tabs patches..."
        mkdir -p helium-test/patches/helium/ui/
        cp patches-repo/helium/patches/helium/ui/*.patch helium-test/patches/helium/ui/

        echo ""
        echo "âœ… Patches copied:"
        ls -lh helium-test/patches/helium/ui/*.patch | grep vertical

    - name: Verify patches are ready
      run: |
        cd helium-test
        echo "âœ… Patches are ready to be used with Helium's build system!"
        echo ""
        echo "Patch files available:"
        find patches/helium/ui -name "*vertical*" -o -name "*hide-horizontal*"

  create-build-instructions:
    name: Generate Build Instructions
    runs-on: ubuntu-latest
    needs: test-patch-application

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create platform-specific instructions
      run: |
        cat > BUILD_ON_GITHUB_ACTIONS.md << 'EOF'
# Building Helium with Vertical Tabs on GitHub Actions

## âš ï¸ Important Understanding

The main `helium` repository (https://github.com/imputnet/helium) contains only **patches and configuration**, not build scripts.

Actual building happens in **platform-specific repositories**:
- **macOS**: https://github.com/imputnet/helium-macos
- **Linux**: https://github.com/imputnet/helium-linux
- **Windows**: https://github.com/imputnet/helium-windows

## ðŸŽ¯ How to Build with Our Vertical Tabs Patches

### Option 1: Use Platform-Specific Repo (Recommended for GitHub Actions)

1. **Fork the platform repo** you want to build for:
   ```bash
   # Example for macOS
   gh repo fork imputnet/helium-macos --clone
   cd helium-macos
   ```

2. **Add our vertical tabs patches**:
   ```bash
   # Download patches from this repo
   curl -L https://github.com/LorenzoTTGT/helium-with-sidetabs/archive/main.zip -o patches.zip
   unzip patches.zip

   # Copy to platform repo
   cp helium-with-sidetabs-main/helium/patches/helium/ui/*vertical*.patch patches/helium/ui/
   cp helium-with-sidetabs-main/helium/patches/helium/ui/hide-horizontal-tabs.patch patches/helium/ui/

   # Commit and push
   git add patches/helium/ui/
   git commit -m "Add vertical tabs patches"
   git push
   ```

3. **Trigger the build**:
   - Go to Actions tab in your forked repo
   - Run the existing "Build" workflow
   - The patches will be automatically applied during build

### Option 2: Local Build with Main Helium Repo

Since the main helium repo doesn't have build scripts, you need to use the **ungoogled-chromium** build system:

1. **Clone ungoogled-chromium**:
   ```bash
   git clone https://github.com/ungoogled-software/ungoogled-chromium.git
   cd ungoogled-chromium
   ```

2. **Copy Helium's patches** (including our vertical tabs patches):
   ```bash
   # Clone this repo with patches
   git clone https://github.com/LorenzoTTGT/helium-with-sidetabs.git ../helium-patches

   # Copy all patches
   cp -r ../helium-patches/helium/patches/* patches/
   ```

3. **Build using ungoogled-chromium's scripts**:
   ```bash
   python3 build.py
   ```

## ðŸš€ Quick Start: Fork helium-macos and Add Patches

```bash
# 1. Fork and clone helium-macos
gh repo fork imputnet/helium-macos --clone
cd helium-macos

# 2. Download and add vertical tabs patches
mkdir -p patches/helium/ui
cd patches/helium/ui
curl -O https://raw.githubusercontent.com/LorenzoTTGT/helium-with-sidetabs/main/helium/patches/helium/ui/vertical-tabs.patch
curl -O https://raw.githubusercontent.com/LorenzoTTGT/helium-with-sidetabs/main/helium/patches/helium/ui/vertical-tabs-resizable.patch
curl -O https://raw.githubusercontent.com/LorenzoTTGT/helium-with-sidetabs/main/helium/patches/helium/ui/vertical-tabs-context-menu.patch
curl -O https://raw.githubusercontent.com/LorenzoTTGT/helium-with-sidetabs/main/helium/patches/helium/ui/hide-horizontal-tabs.patch
curl -O https://raw.githubusercontent.com/LorenzoTTGT/helium-with-sidetabs/main/helium/patches/helium/ui/vertical-tab-style.patch
cd ../../..

# 3. Commit and push
git add patches/helium/ui/
git commit -m "feat: Add vertical tabs with resizable sidebar"
git push

# 4. Trigger build via GitHub Actions
gh workflow run build.yml
```

## ðŸ“¦ What You'll Get

After the build completes:
- **macOS**: `Helium.app` with vertical tabs
- **Linux**: `helium` binary with vertical tabs
- **Windows**: `helium.exe` with vertical tabs

## ðŸŽ¨ Features Included

- âœ… Vertical tabs sidebar on the left (default)
- âœ… Resizable sidebar: drag the edge to resize (150-500px)
- âœ… Right-click context menu:
  - Move sidebar to left or right
  - Reset sidebar width to default
- âœ… Persistent preferences (saved per profile)
- âœ… Top tab bar completely hidden
- âœ… Custom styling: 240Ã—36px tabs optimized for vertical layout

## ðŸ”§ Launch with Vertical Tabs

After building, enable the feature:

**macOS**:
```bash
open -a Helium --args --enable-features=VerticalTabs
```

**Linux**:
```bash
./helium --enable-features=VerticalTabs
```

**Windows**:
```cmd
helium.exe --enable-features=VerticalTabs
```

Or go to `helium://flags` and search for "Vertical Tabs", then enable it.

---

**Note**: Building Chromium/Helium requires significant resources:
- **Disk space**: 60-80 GB
- **RAM**: 16+ GB recommended
- **Time**: 2-6 hours depending on CPU

GitHub Actions runners may timeout or run out of disk space. For best results, use the platform-specific repos which have optimized build configurations.
EOF

        cat BUILD_ON_GITHUB_ACTIONS.md

    - name: Upload instructions
      uses: actions/upload-artifact@v4
      with:
        name: build-instructions
        path: BUILD_ON_GITHUB_ACTIONS.md
        retention-days: 90

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [validate-patches, test-patch-application, create-build-instructions]

    steps:
    - name: Display summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… VERTICAL TABS PATCHES - READY TO USE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ðŸ“¦ Patch files validated and ready!"
        echo ""
        echo "ðŸŽ¯ Next Steps:"
        echo ""
        echo "1. Fork a platform-specific Helium repo:"
        echo "   â€¢ macOS: github.com/imputnet/helium-macos"
        echo "   â€¢ Linux: github.com/imputnet/helium-linux"
        echo "   â€¢ Windows: github.com/imputnet/helium-windows"
        echo ""
        echo "2. Copy the 5 patch files to: patches/helium/ui/"
        echo ""
        echo "3. Push and trigger their build workflow"
        echo ""
        echo "ðŸ“„ Download the build instructions artifact for details!"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
